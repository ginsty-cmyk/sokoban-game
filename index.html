<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sokoban Speedrun: HYPER-SPEED</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #050505; --panel: rgba(30, 30, 30, 0.85); --accent: #00d2ff; 
            --danger: #ff0040; --success: #00ff88; --text: #ffffff; 
        }
        * { user-select: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            background: var(--bg); display: flex; flex-direction: column; align-items: center; 
            font-family: 'Orbitron', sans-serif; color: var(--text); 
            margin: 0; overflow: hidden; height: 100vh; position: relative;
        }
        
        /* 1. 速度感背景：星际跃迁效果 */
        #bg-canvas { position: absolute; top: 0; left: 0; z-index: -1; width: 100%; height: 100%; }

        /* 2. 毫秒级计时器美化 */
        #timer-box {
            margin-top: 25px; text-align: center; background: var(--panel);
            padding: 15px 40px; border-radius: 4px; border-right: 4px solid var(--danger);
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.3); z-index: 10;
        }
        #st { 
            font-family: 'Share Tech Mono', monospace; font-size: 3.5rem; 
            font-weight: bold; color: var(--danger); text-shadow: 0 0 10px rgba(255, 0, 64, 0.8);
            line-height: 1; display: inline-block;
        }
        .ms { font-size: 1.5rem; opacity: 0.8; margin-left: 2px; }
        .timer-label { font-size: 0.7rem; text-transform: uppercase; color: #aaa; letter-spacing: 4px; margin-bottom: 5px;}

        /* 数字跳动动感动画 */
        .pulse { animation: pulse 0.1s linear; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        #ui-stats { margin: 15px 0; display: flex; gap: 20px; font-size: 1rem; align-items: center; z-index: 10; letter-spacing: 1px;}
        .stat-item span { color: var(--accent); font-weight: 900; }

        #reset-btn {
            background: none; color: var(--danger); border: 2px solid var(--danger); padding: 8px 18px;
            font-family: 'Orbitron'; font-weight: 900; cursor: pointer; transition: 0.2s;
        }
        #reset-btn:hover { background: var(--danger); color: white; box-shadow: 0 0 15px var(--danger); }

        #game-container { position: relative; flex-grow: 1; display: flex; justify-content: center; align-items: center; width: 100%; z-index: 5; }
        canvas#cvs { background: rgba(10, 10, 10, 0.9); border: 1px solid rgba(0, 210, 255, 0.3); box-shadow: 0 0 40px rgba(0,0,0,1); }

        /* 3. 最终结算面板美化 */
        .modal { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.98); backdrop-filter: blur(20px);
            justify-content: center; align-items: center; z-index: 100; 
        }
        .modal-content { 
            background: linear-gradient(145deg, #111, #222); color: #fff; padding: 40px; 
            border: 1px solid var(--accent); width: 90%; max-width: 450px; text-align: center;
            box-shadow: 0 0 50px rgba(0, 210, 255, 0.2);
        }
        .modal-content h2 { font-weight: 900; letter-spacing: 5px; color: var(--accent); margin-bottom: 30px; }
        .score-val { font-size: 60px; font-weight: 900; color: var(--danger); font-family: 'Orbitron'; text-shadow: 0 0 20px var(--danger); }
        .result-grid { 
            text-align: left; margin: 25px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            font-family: 'Share Tech Mono'; border-top: 1px solid #333; padding-top: 20px;
        }
        .result-label { color: #888; font-size: 0.8rem; }
        .result-data { color: #fff; font-size: 1.1rem; display: block; }
        
        #msg { position: fixed; top: 15%; font-size: 40px; color: var(--success); font-weight: 900; opacity: 0; transition: 0.2s; pointer-events: none; text-shadow: 0 0 20px var(--success); z-index: 50; }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="msg">GOAL!!!</div>
    
    <div id="timer-box">
        <div class="timer-label">Mission Elapsed</div>
        <div id="st">00.000</div>
    </div>

    <div id="ui-stats">
        <div class="stat-item">SECTOR: <span id="lv">1</span>/12</div>
        <div class="stat-item">STP: <span id="steps">0</span></div>
        <button id="reset-btn">ABORT (R)</button>
    </div>
    
    <div id="game-container">
        <canvas id="cvs"></canvas>
    </div>

    <div id="res" class="modal">
        <div class="modal-content">
            <h2>DEBRIEFING</h2>
            <div id="f-score" class="score-val">0</div>
            <p id="f-rank" style="font-weight:900; font-size:2rem; color:var(--success); margin:10px 0;">RANK: S</p>
            
            <div class="result-grid">
                <div><span class="result-label">TOTAL STEPS</span><span class="result-data" id="f-steps">0</span></div>
                <div><span class="result-label">MIN STEPS REF</span><span class="result-data" id="f-min" style="color:var(--success)">0</span></div>
                <div><span class="result-label">PURE TIME</span><span class="result-data" id="f-pure">0s</span></div>
                <div><span class="result-label">PENALTY</span><span class="result-data" id="f-penalty" style="color:var(--danger)">+0s</span></div>
            </div>
            <button onclick="location.reload()" style="background:var(--accent); color:#000; border:none; padding:15px 40px; font-family:'Orbitron'; font-weight:900; cursor:pointer; width:100%;">RE-ENGAGE</button>
        </div>
    </div>

<script>
/** * 星际跃迁背景 (体现速度感) */
const bgCanvas = document.getElementById('bg-canvas');
const bgCtx = bgCanvas.getContext('2d');
let stars = [];
const starCount = 400;

function initStars() {
    bgCanvas.width = window.innerWidth;
    bgCanvas.height = window.innerHeight;
    stars = [];
    for(let i=0; i<starCount; i++) {
        stars.push({
            x: Math.random() * bgCanvas.width - bgCanvas.width/2,
            y: Math.random() * bgCanvas.height - bgCanvas.height/2,
            z: Math.random() * bgCanvas.width,
            o: Math.random()
        });
    }
}

function drawStars() {
    bgCtx.fillStyle = '#050505';
    bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
    bgCtx.save();
    bgCtx.translate(bgCanvas.width/2, bgCanvas.height/2);
    
    stars.forEach(s => {
        s.z -= (5 + curIdx); // 随着关卡进度变快
        if(s.z <= 0) s.z = bgCanvas.width;
        
        let sx = (s.x / s.z) * bgCanvas.width;
        let sy = (s.y / s.z) * bgCanvas.height;
        let size = (1 - s.z / bgCanvas.width) * 3;
        
        bgCtx.fillStyle = `rgba(0, 210, 255, ${1 - s.z/bgCanvas.width})`;
        bgCtx.beginPath();
        bgCtx.arc(sx, sy, size, 0, Math.PI*2);
        bgCtx.fill();
        
        // 增加流星连线效果
        bgCtx.strokeStyle = `rgba(0, 210, 255, ${(1 - s.z/bgCanvas.width)*0.3})`;
        bgCtx.lineWidth = size;
        bgCtx.beginPath();
        bgCtx.moveTo(sx, sy);
        bgCtx.lineTo(sx * 1.05, sy * 1.05);
        bgCtx.stroke();
    });
    bgCtx.restore();
    requestAnimationFrame(drawStars);
}
window.addEventListener('resize', initStars);
initStars(); drawStars();

/** * 游戏逻辑核心 */
let TILE = 70; 
const canvas = document.getElementById('cvs');
const ctx = canvas.getContext('2d');
let levels = [], queue = [], curIdx = 0, isSwitching = false;
let state = { p:{x:0, y:0, rx:0, ry:0}, b:[], walls:[], targets:[], resets:0, totalSteps:0, sumMinSteps:0, startTime:0, finished:false };

// 操作监听
window.addEventListener('keydown', e => {
    if (state.finished || isSwitching) return;
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
    const key = e.key.toLowerCase();
    if (key === "arrowup" || key === "w") move(0, -1);
    if (key === "arrowdown" || key === "s") move(0, 1);
    if (key === "arrowleft" || key === "a") move(-1, 0);
    if (key === "arrowright" || key === "d") move(1, 0);
    if (key === "r") resetLevel(true);
});

// 手势滑动
let touchStart = null;
document.addEventListener('touchstart', e => { touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY }; }, { passive: true });
document.addEventListener('touchend', e => {
    if (!touchStart || isSwitching || state.finished) return;
    const dx = e.changedTouches[0].clientX - touchStart.x;
    const dy = e.changedTouches[0].clientY - touchStart.y;
    if (Math.max(Math.abs(dx), Math.abs(dy)) > 30) {
        if (Math.abs(dx) > Math.abs(dy)) move(dx > 0 ? 1 : -1, 0);
        else move(0, dy > 0 ? 1 : -1);
    }
    touchStart = null;
}, { passive: true });

document.getElementById('reset-btn').onclick = () => { canvas.focus(); if(confirm("ABORT MISSION? -500 PTS")) resetLevel(true); };

async function init() {
    canvas.tabIndex = 1; canvas.focus();
    try {
        const r = await fetch('levels.json');
        levels = await r.json();
        queue = levels.sort(() => .5 - Math.random()).slice(0, 12);
        state.startTime = Date.now();
        loadLevel(0);
        requestAnimationFrame(loop);
    } catch (e) { alert("Data load failed!"); }
}

function loadLevel(idx) {
    const d = queue[idx];
    state.walls = d.walls; state.targets = d.targets;
    state.initP = d.player; state.initB = d.boxes;
    state.sumMinSteps += d.min;
    const maxDim = Math.max(d.walls.length, d.walls[0].length);
    TILE = maxDim > 10 ? 45 : 65; 
    state.p.x = d.player[0]; state.p.y = d.player[1];
    state.p.rx = d.player[0] * TILE; state.p.ry = d.player[1] * TILE;
    state.b = d.boxes.map(b => ({ x: b[0], y: b[1], rx: b[0]*TILE, ry: b[1]*TILE }));
    isSwitching = false;
}

function resetLevel(manual) {
    if(isSwitching || state.finished) return;
    state.p.x = state.initP[0]; state.p.y = state.initP[1];
    state.b = state.initB.map(b => ({ x: b[0], y: b[1], rx: b[0]*TILE, ry: b[1]*TILE }));
    if(manual) state.resets++;
}

function move(dx, dy) {
    if(state.finished || isSwitching) return;
    let nx = state.p.x + dx, ny = state.p.y + dy;
    if(state.walls[ny][nx] === 1) return;
    let bi = state.b.findIndex(b => b.x === nx && b.y === ny);
    if(bi !== -1) {
        let bx = nx + dx, by = ny + dy;
        if(state.walls[by][bx] === 1 || state.b.some(b => b.x===bx && b.y===by)) return;
        state.b[bi].x = bx; state.b[bi].y = by;
    }
    state.p.x = nx; state.p.y = ny;
    state.totalSteps++;
    // 增加计时器抖动反馈
    document.getElementById('st').classList.remove('pulse');
    void document.getElementById('st').offsetWidth;
    document.getElementById('st').classList.add('pulse');
}

function loop() {
    if(state.finished) return;
    state.p.rx += (state.p.x * TILE - state.p.rx) * 0.3;
    state.p.ry += (state.p.y * TILE - state.p.ry) * 0.3;
    state.b.forEach(b => { b.rx += (b.x * TILE - b.rx) * 0.3; b.ry += (b.y * TILE - b.ry) * 0.3; });
    draw();
    updateUI();
    if(!isSwitching && state.b.every(b => state.targets.some(t => t[0]===b.x && t[1]===b.y))) triggerWin();
    requestAnimationFrame(loop);
}

function triggerWin() {
    isSwitching = true;
    document.getElementById('msg').style.opacity = 1;
    setTimeout(() => {
        document.getElementById('msg').style.opacity = 0;
        if (curIdx < 11) { curIdx++; loadLevel(curIdx); }
        else { state.finished = true; showFinalResult(); }
    }, 400);
}

function draw() {
    const d = state.walls;
    canvas.width = d[0].length * TILE; canvas.height = d.length * TILE;
    d.forEach((r,y) => r.forEach((v,x) => {
        if(v===1) { 
            ctx.fillStyle="#1a1a1a"; ctx.beginPath(); ctx.roundRect(x*TILE+2, y*TILE+2, TILE-4, TILE-4, 4); ctx.fill(); 
            ctx.strokeStyle="rgba(0, 210, 255, 0.2)"; ctx.stroke();
        } else { ctx.fillStyle="rgba(20,20,20,0.6)"; ctx.fillRect(x*TILE, y*TILE, TILE, TILE); }
    }));
    state.targets.forEach(t => {
        ctx.strokeStyle=varColor('--success'); ctx.lineWidth=1; ctx.beginPath(); ctx.arc(t[0]*TILE+TILE/2, t[1]*TILE+TILE/2, TILE/4, 0, 7); ctx.stroke();
    });
    state.b.forEach(b => {
        const ok = state.targets.some(t => t[0]===b.x && t[1]===b.y);
        ctx.fillStyle = ok ? varColor('--success') : "#ff8800";
        ctx.beginPath(); ctx.roundRect(b.rx+6, b.ry+6, TILE-12, TILE-12, 2); ctx.fill();
        if(ok) { ctx.shadowBlur = 15; ctx.shadowColor = varColor('--success'); }
    });
    ctx.shadowBlur = 15; ctx.shadowColor = varColor('--accent');
    ctx.fillStyle=varColor('--accent'); ctx.beginPath(); ctx.arc(state.p.rx+TILE/2, state.p.ry+TILE/2, TILE/3, 0, 7); ctx.fill();
    ctx.shadowBlur = 0;
}

function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }

function updateUI() {
    // 毫秒级时间计算
    const elapsed = (Date.now() - state.startTime);
    const displayMS = elapsed + (state.resets * 10000);
    const totalSec = Math.floor(displayMS / 1000);
    const milSec = Math.floor(displayMS % 1000);
    
    document.getElementById('st').innerHTML = `${totalSec.toString().padStart(2, '0')}<span class="ms">.${milSec.toString().padStart(3, '0')}</span>`;
    document.getElementById('lv').innerText = curIdx + 1;
    document.getElementById('steps').innerText = state.totalSteps;
}

function showFinalResult() {
    const pureTime = Math.floor((Date.now() - state.startTime)/1000);
    const penaltyTime = state.resets * 10;
    const totalTime = pureTime + penaltyTime;
    
    let stepRatio = state.sumMinSteps / state.totalSteps;
    let stepScore = Math.round(5000 * Math.pow(stepRatio, 1.8)); 
    let timeScore = Math.max(0, 5000 - (totalTime - 150) * 80);
    let finalScore = Math.max(0, stepScore + timeScore - (state.resets * 500));
    
    let rank = finalScore >= 9500 ? "S" : finalScore >= 8500 ? "A" : finalScore >= 7000 ? "B" : "C";

    document.getElementById('f-steps').innerText = state.totalSteps;
    document.getElementById('f-min').innerText = state.sumMinSteps; // 显示理论最少步数
    document.getElementById('f-pure').innerText = pureTime + "s";
    document.getElementById('f-penalty').innerText = "+" + penaltyTime + "s";
    document.getElementById('f-score').innerText = finalScore.toLocaleString();
    document.getElementById('f-rank').innerText = "RANK: " + rank;
    document.getElementById('f-rank').style.color = rank === "S" ? "var(--success)" : "var(--accent)";
    document.getElementById('res').style.display = 'flex';
}

init();
</script>
</body>
</html>
