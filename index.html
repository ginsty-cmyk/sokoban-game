<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sokoban Speedrun: Particle Edition</title>
    <style>
        :root { 
            --bg: #0d0d0d; --panel: #1e1e1e; --accent: #00a8ff; 
            --danger: #ff4757; --success: #2ed573; --text: #f1f2f6; 
        }
        * { user-select: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            background: var(--bg); display: flex; flex-direction: column; align-items: center; 
            font-family: 'Segoe UI', system-ui, sans-serif; color: var(--text); 
            margin: 0; overflow: hidden; height: 100vh; position: relative;
        }
        
        /* 背景粒子层 */
        #bg-canvas {
            position: absolute; top: 0; left: 0; z-index: -1;
            width: 100%; height: 100%;
        }

        #timer-box {
            margin-top: 20px; text-align: center; background: rgba(255,255,255,0.05);
            padding: 10px 40px; border-radius: 15px; border-left: 5px solid var(--danger);
            backdrop-filter: blur(5px); z-index: 10;
        }
        #st { 
            font-family: 'Courier New', monospace; font-size: 4rem; 
            font-weight: 900; color: var(--danger); text-shadow: 0 0 15px rgba(255, 71, 87, 0.5);
            line-height: 1;
        }
        .timer-label { font-size: 0.8rem; text-transform: uppercase; color: #888; letter-spacing: 2px; }

        #ui-stats { 
            margin: 15px 0; display: flex; gap: 20px; font-size: 1.1rem; font-weight: bold; align-items: center; z-index: 10;
        }
        .stat-item span { color: var(--accent); }

        #reset-btn {
            background: var(--danger); color: white; border: none; padding: 10px 20px;
            border-radius: 10px; font-weight: bold; font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 4px 0 #b33939; transition: 0.1s; outline: none;
        }
        #reset-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #b33939; }

        #game-container { 
            position: relative; flex-grow: 1; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
            width: 100%; touch-action: none; z-index: 5;
        }
        canvas#cvs { 
            background: rgba(45, 45, 45, 0.8); border-radius: 12px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .modal { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.95); backdrop-filter: blur(15px);
            color: white; flex-direction: column; justify-content: center; align-items: center; z-index: 100; 
        }
        .modal-content { background: #fff; color: #333; padding: 30px; border-radius: 24px; width: 85%; max-width: 400px; text-align: center; }
        .score-val { font-size: 50px; font-weight: 900; color: var(--danger); line-height: 1.2; }
        
        #msg { position: fixed; top: 15%; font-size: 32px; color: var(--success); font-weight: 900; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 50; }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>

    <div id="msg">LEVEL CLEAR</div>
    
    <div id="timer-box">
        <div class="timer-label">Extreme Pressure</div>
        <div id="st">000</div>
    </div>

    <div id="ui-stats">
        <div class="stat-item">LV: <span id="lv">1</span>/12</div>
        <div class="stat-item">STEPS: <span id="steps">0</span></div>
        <button id="reset-btn">RESET (R)</button>
    </div>
    
    <div id="game-container">
        <canvas id="cvs"></canvas>
    </div>

    <div id="res" class="modal">
        <div class="modal-content">
            <h2 style="margin:0">CHALLENGE COMPLETE</h2>
            <div id="f-score" class="score-val">0</div>
            <p id="f-rank" style="font-weight:bold; font-size:1.5rem; color:var(--accent); margin:5px 0;">RANK: C</p>
            <div style="text-align:left; margin: 15px 0; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.9rem; line-height: 1.6;">
                <div>总移动步数: <span id="f-steps" style="font-weight:bold">0</span></div>
                <div>纯操作耗时: <span id="f-pure">0</span>s</div>
                <div>重置罚时: <span id="f-penalty" style="color:var(--danger)">+0</span>s</div>
            </div>
            <button onclick="location.reload()" style="background:var(--accent); color:white; border:none; padding:12px 30px; border-radius:8px; font-weight:bold; cursor:pointer;">RESTART</button>
        </div>
    </div>

<script>
/** * 粒子背景系统 
 */
const bgCanvas = document.getElementById('bg-canvas');
const bgCtx = bgCanvas.getContext('2d');
let particles = [];

function initParticles() {
    bgCanvas.width = window.innerWidth;
    bgCanvas.height = window.innerHeight;
    particles = [];
    for(let i=0; i<60; i++) {
        particles.push({
            x: Math.random() * bgCanvas.width,
            y: Math.random() * bgCanvas.height,
            size: Math.random() * 2 + 1,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            color: Math.random() > 0.5 ? '#00a8ff' : '#2ed573',
            opacity: Math.random()
        });
    }
}

function drawParticles() {
    bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
    particles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if(p.x < 0 || p.x > bgCanvas.width) p.vx *= -1;
        if(p.y < 0 || p.y > bgCanvas.height) p.vy *= -1;
        bgCtx.globalAlpha = p.opacity;
        bgCtx.fillStyle = p.color;
        bgCtx.beginPath();
        bgCtx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        bgCtx.fill();
    });
    requestAnimationFrame(drawParticles);
}
window.addEventListener('resize', initParticles);
initParticles();
drawParticles();

/** * 游戏核心系统 (延续之前的高级逻辑) 
 */
let TILE = 70; 
const canvas = document.getElementById('cvs');
const ctx = canvas.getContext('2d');
let levels = [], queue = [], curIdx = 0, isSwitching = false;
let state = { p:{x:0, y:0, rx:0, ry:0}, b:[], walls:[], targets:[], resets:0, totalSteps:0, sumMinSteps:0, startTime:0, finished:false };

// 滑动与键盘监听 (保持不变)
let touchStart = null;
document.addEventListener('touchstart', e => { touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY }; }, { passive: true });
document.addEventListener('touchend', e => {
    if (!touchStart || isSwitching || state.finished) return;
    const dx = e.changedTouches[0].clientX - touchStart.x;
    const dy = e.changedTouches[0].clientY - touchStart.y;
    if (Math.max(Math.abs(dx), Math.abs(dy)) > 30) {
        if (Math.abs(dx) > Math.abs(dy)) move(dx > 0 ? 1 : -1, 0);
        else move(0, dy > 0 ? 1 : -1);
    }
    touchStart = null;
}, { passive: true });

window.addEventListener('keydown', e => {
    if (state.finished || isSwitching) return;
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
    const key = e.key.toLowerCase();
    if (key === "arrowup" || key === "w") move(0, -1);
    if (key === "arrowdown" || key === "s") move(0, 1);
    if (key === "arrowleft" || key === "a") move(-1, 0);
    if (key === "arrowright" || key === "d") move(1, 0);
    if (key === "r") resetLevel(true);
});

document.getElementById('reset-btn').onclick = () => { canvas.focus(); if(confirm("确定重置？(罚时10s+扣500分)")) resetLevel(true); };

async function init() {
    canvas.tabIndex = 1;
    canvas.focus();
    try {
        const r = await fetch('levels.json');
        levels = await r.json();
        queue = levels.sort(() => .5 - Math.random()).slice(0, 12);
        state.startTime = Date.now();
        loadLevel(0);
        requestAnimationFrame(loop);
    } catch (e) { alert("Error loading levels.json"); }
}

function loadLevel(idx) {
    const d = queue[idx];
    state.walls = d.walls;
    state.targets = d.targets;
    state.initP = d.player;
    state.initB = d.boxes;
    state.sumMinSteps += d.min;
    
    const maxDim = Math.max(d.walls.length, d.walls[0].length);
    TILE = maxDim > 10 ? 45 : 65; 

    state.p.x = d.player[0]; state.p.y = d.player[1];
    state.p.rx = d.player[0] * TILE; state.p.ry = d.player[1] * TILE;
    state.b = d.boxes.map(b => ({ x: b[0], y: b[1], rx: b[0]*TILE, ry: b[1]*TILE }));
    isSwitching = false;
}

function resetLevel(manual) {
    if(isSwitching || state.finished) return;
    state.p.x = state.initP[0]; state.p.y = state.initP[1];
    state.b = state.initB.map(b => ({ x: b[0], y: b[1], rx: b[0]*TILE, ry: b[1]*TILE }));
    if(manual) state.resets++;
}

function move(dx, dy) {
    if(state.finished || isSwitching) return;
    let nx = state.p.x + dx, ny = state.p.y + dy;
    if(state.walls[ny][nx] === 1) return;
    let bi = state.b.findIndex(b => b.x === nx && b.y === ny);
    if(bi !== -1) {
        let bx = nx + dx, by = ny + dy;
        if(state.walls[by][bx] === 1 || state.b.some(b => b.x===bx && b.y===by)) return;
        state.b[bi].x = bx; state.b[bi].y = by;
    }
    state.p.x = nx; state.p.y = ny;
    state.totalSteps++;
}

function loop() {
    if(state.finished) return;
    state.p.rx += (state.p.x * TILE - state.p.rx) * 0.28;
    state.p.ry += (state.p.y * TILE - state.p.ry) * 0.28;
    state.b.forEach(b => { b.rx += (b.x * TILE - b.rx) * 0.28; b.ry += (b.y * TILE - b.ry) * 0.28; });
    draw();
    updateUI();
    if(!isSwitching && state.b.every(b => state.targets.some(t => t[0]===b.x && t[1]===b.y))) triggerWin();
    requestAnimationFrame(loop);
}

function triggerWin() {
    isSwitching = true;
    document.getElementById('msg').style.opacity = 1;
    setTimeout(() => {
        document.getElementById('msg').style.opacity = 0;
        if (curIdx < 11) { curIdx++; loadLevel(curIdx); }
        else { state.finished = true; showFinalResult(); }
    }, 600);
}

function draw() {
    const d = state.walls;
    canvas.width = d[0].length * TILE;
    canvas.height = d.length * TILE;
    d.forEach((r,y) => r.forEach((v,x) => {
        if(v===1) { ctx.fillStyle="#3a3a3a"; ctx.beginPath(); ctx.roundRect(x*TILE+2, y*TILE+2, TILE-4, TILE-4, 8); ctx.fill(); }
        else { ctx.fillStyle="rgba(40,40,40,0.5)"; ctx.fillRect(x*TILE, y*TILE, TILE, TILE); }
    }));
    state.targets.forEach(t => {
        ctx.strokeStyle="rgba(46, 213, 115, 0.6)"; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(t[0]*TILE+TILE/2, t[1]*TILE+TILE/2, TILE/5, 0, 7); ctx.stroke();
    });
    state.b.forEach(b => {
        const ok = state.targets.some(t => t[0]===b.x && t[1]===b.y);
        ctx.fillStyle = ok ? varColor('--success') : "#e67e22";
        ctx.beginPath(); ctx.roundRect(b.rx+5, b.ry+5, TILE-10, TILE-10, 8); ctx.fill();
        if(ok) { ctx.shadowBlur = 10; ctx.shadowColor = varColor('--success'); }
        else { ctx.shadowBlur = 0; }
    });
    ctx.shadowBlur = 15; ctx.shadowColor = varColor('--accent');
    ctx.fillStyle=varColor('--accent'); ctx.beginPath(); ctx.arc(state.p.rx+TILE/2, state.p.ry+TILE/2, TILE/3, 0, 7); ctx.fill();
    ctx.shadowBlur = 0;
}

function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }

function updateUI() {
    const elapsed = (Date.now() - state.startTime)/1000;
    const displayTime = Math.floor(elapsed + (state.resets * 10));
    document.getElementById('st').innerText = displayTime.toString().padStart(3, '0');
    document.getElementById('lv').innerText = curIdx + 1;
    document.getElementById('steps').innerText = state.totalSteps;
}

function showFinalResult() {
    const pureTime = Math.floor((Date.now() - state.startTime)/1000);
    const totalTime = pureTime + (state.resets * 10);
    let stepScore = Math.round(5000 * Math.pow(state.sumMinSteps / state.totalSteps, 1.8)); 
    let timeScore = 5000 - (totalTime - 150) * 80; 
    timeScore = Math.min(6000, Math.max(0, timeScore));
    let finalScore = Math.max(0, stepScore + timeScore - (state.resets * 500));
    let rank = finalScore >= 9500 ? "S" : finalScore >= 8500 ? "A" : finalScore >= 7000 ? "B" : "C";

    document.getElementById('f-steps').innerText = state.totalSteps;
    document.getElementById('f-pure').innerText = pureTime;
    document.getElementById('f-penalty').innerText = state.resets * 10;
    document.getElementById('f-score').innerText = finalScore.toLocaleString();
    document.getElementById('f-rank').innerText = "RANK: " + rank;
    document.getElementById('res').style.display = 'flex';
}

init();
</script>
</body>
</html>
